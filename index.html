<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PHENO&CO — Carte de visite virtuelle</title>
  <style>
    :root{
      --bg:#0b0b0b; --txt:#fafafa; --muted:#a7a7a7;
      --yellow:#ffcb05; --dark:#2a2a2a; --green:#19c37d; --red:#ff4d4d;
      --card:#121212; --brand:#ffcb05;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.5}
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    .center{text-align:center}
    .logo{height:86px;margin:20px auto 6px;display:block;filter:brightness(1.1)}
    h1{margin:.2rem 0 0;font-size:2.2rem;letter-spacing:.8px;color:var(--brand)}
    .sub{color:var(--muted);margin:.25rem 0 1.5rem}
    .btn{width:100%;border:0;border-radius:16px;padding:18px 20px;font-weight:700;font-size:1.1rem;cursor:pointer;display:block;margin:12px auto;transition:.2s}
    .btn.yellow{background:var(--yellow);color:#111}
    .btn.dark{background:#3a3a3a;color:#fff}
    .btn.green{background:var(--green);color:#071e12}
    .btn:hover{transform:translateY(-1px);opacity:.97}
    .card{background:var(--card);border:1px solid #1c1c1c;border-radius:18px;padding:18px;margin:18px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    label{font-weight:600;font-size:.97rem}
    input,select,textarea{
      width:100%;margin-top:6px;background:#0f0f0f;border:1px solid #222;border-radius:12px;
      color:var(--txt);padding:12px 14px;font-size:1rem;outline:none
    }
    input[type="date"]{color-scheme:dark}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:.92rem}
    .totals{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .total-box{background:#0f0f0f;border:1px solid #222;border-radius:14px;padding:12px}
    .total-box h4{margin:0 0 6px;font-size:1rem}
    .ok{color:#29d07e}.warn{color:#ffd166}.err{color:var(--red)}
    .footer{margin:40px 0 10px;color:#888;font-size:.9rem}
    .hide{display:none}
    @media (min-width:720px){ .btn{max-width:520px} .row,.row-3{grid-template-columns:repeat(3,1fr)} .totals{grid-template-columns:repeat(3,1fr)} }
    @media (min-width:980px){ .row{grid-template-columns:repeat(2,1fr)} .row-3{grid-template-columns:repeat(3,1fr)} .totals{grid-template-columns:repeat(4,1fr)} }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- ENTÊTE -->
    <div class="center">
      <!-- Remplace src si tu as un logo local -->
      <img class="logo" src="https://raw.githubusercontent.com/enchanted-titles/assets/main/phenoco-logo-white.png" alt="PHENO&CO">
      <h1>PHENO&CO</h1>
      <div class="sub">Barbershop • Depuis 2009 • Montpellier</div>

      <!-- BOUTONS PRINCIPAUX (verticaux, grands) -->
      <button id="btnReserve" class="btn yellow">Réserver Fauteuil</button>
      <a class="btn dark" href="https://phenoco.simplybook.it/v2/" target="_blank" rel="noopener">Prendre RDV Coiffure</a>
      <a class="btn green" href="https://wa.me/33769432605" target="_blank" rel="noopener">Contact WhatsApp</a>
    </div>

    <!-- FORMULAIRE DE LOCATION (affiché au clic) -->
    <form id="locForm" class="card hide" onsubmit="sendMail(event)">
      <h2 class="center" style="margin-top:0">Location de fauteuil</h2>

      <!-- Identité -->
      <div class="grid">
        <div>
          <label>Nom complet</label>
          <input required name="full_name" placeholder="Nom & prénom">
        </div>
        <div>
          <label>Téléphone (WhatsApp)</label>
          <input required name="phone" placeholder="+33 7 ..." />
        </div>
        <div>
          <label>Email</label>
          <input required type="email" name="email" placeholder="votre@email.com" />
        </div>
      </div>

      <!-- Période -->
      <div class="card">
        <div class="row">
          <div>
            <label>Date de début</label>
            <input required type="date" name="date_start" id="date_start">
          </div>
          <div>
            <label>Date de fin</label>
            <input required type="date" name="date_end" id="date_end">
          </div>
        </div>

        <div class="row">
          <div>
            <label>Heure d’arrivée</label>
            <select required name="start_hour" id="start_hour"></select>
          </div>
          <div>
            <label>Heures par jour</label>
            <select required name="hours_per_day" id="hours_per_day"></select>
          </div>
        </div>
        <div class="muted">Horaires salon : 10:00 → 18:00</div>
      </div>

      <!-- Formules -->
      <div class="card">
        <h3 style="margin-top:0">Formule de location</h3>

        <div class="row">
          <div>
            <label>Type</label>
            <select id="type_location" name="type_location">
              <option value="short">Courte durée</option>
              <option value="long">Longue durée</option>
            </select>
          </div>
          <div id="short_wrap">
            <label>Courte durée — choisir</label>
            <select id="short_formula" name="short_formula">
              <option value="1h" data-ht="10">1h — 10€ HT</option>
              <option value="4h" data-ht="45">½ journée (4h) — 45€ HT</option>
              <option value="8h" data-ht="70">1 journée (8h) — 70€ HT</option>
              <option value="5d" data-ht="280">1 semaine (5 jours) — 280€ HT</option>
            </select>
          </div>
          <div id="long_wrap" class="hide">
            <label>Longue durée — tarif/jour (HT)</label>
            <select id="long_formula" name="long_formula">
              <option value="1m" data-ht="65">1 mois — 65€ / jour HT</option>
              <option value="3m" data-ht="60">3 mois — 60€ / jour HT</option>
              <option value="6m" data-ht="55">6 mois — 55€ / jour HT</option>
              <option value="12m" data-ht="50">12 mois — 50€ / jour HT</option>
            </select>
          </div>
        </div>
        <div class="muted">En longue durée, redevance 2% appliquée sur le <u>solde TTC</u> (après acompte).</div>
      </div>

      <!-- Matériels (menus déroulants simples) -->
      <div class="card">
        <h3 style="margin-top:0">Location petits matériels (HT / jour)</h3>
        <div class="row-3">
          <div>
            <label>Tondeuse classique (10€)</label>
            <select name="m_clipper">
              <option value="0">0</option><option>1</option><option>2</option>
            </select>
          </div>
          <div>
            <label>Tondeuse finition (8€)</label>
            <select name="m_trimmer">
              <option value="0">0</option><option>1</option><option>2</option>
            </select>
          </div>
          <div>
            <label>Shaver (6€)</label>
            <select name="m_shaver">
              <option value="0">0</option><option>1</option><option>2</option>
            </select>
          </div>
          <div>
            <label>Sèche-cheveux (8€)</label>
            <select name="m_dryer">
              <option value="0">0</option><option>1</option>
            </select>
          </div>
          <div>
            <label>Serviettes lot de 4 (4€)</label>
            <select name="m_towels">
              <option value="0">0</option><option>1</option><option>2</option>
            </select>
          </div>
          <div>
            <label>Cape lavable (1€)</label>
            <select name="m_cape">
              <option value="0">0</option><option>1</option><option>2</option><option>3</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Pack Essentiel — 20€ / jour</label>
            <select name="pack_essentiel">
              <option value="0">Non</option><option value="20">Oui</option>
            </select>
          </div>
          <div>
            <label>Pack Premium — 30€ / jour</label>
            <select name="pack_premium">
              <option value="0">Non</option><option value="30">Oui</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Totaux -->
      <div class="card">
        <h3 style="margin-top:0">Récapitulatif & Totaux</h3>
        <div class="totals">
          <div class="total-box"><h4>HT</h4><div id="t_ht">0 €</div></div>
          <div class="total-box"><h4>TVA 20%</h4><div id="t_tva">0 €</div></div>
          <div class="total-box"><h4>TTC</h4><div id="t_ttc">0 €</div></div>
          <div class="total-box"><h4>Acompte</h4><div id="t_acompte">0 €</div></div>
          <div class="total-box"><h4>Solde TTC</h4><div id="t_solde">0 €</div></div>
          <div class="total-box"><h4>Redevance 2% (LD)</h4><div id="t_redev">0 €</div></div>
          <div class="total-box"><h4>TTC Final</h4><div id="t_final" class="ok">0 €</div></div>
          <div class="total-box"><h4>Équiv. jours réglés</h4><div id="t_days" class="muted">—</div></div>
        </div>
      </div>

      <!-- CGV dynamiques -->
      <div class="card">
        <h3 style="margin-top:0">CGV / Contrat (extrait)</h3>
        <div id="cgvText" class="muted" style="white-space:pre-wrap"></div>
        <label style="display:flex;gap:8px;align-items:center;margin-top:10px">
          <input type="checkbox" id="accept" required style="width:auto"> J’ai lu et j’accepte les CGV / Contrat.
        </label>
      </div>

      <!-- Soumission -->
      <div class="center">
        <button class="btn yellow" type="submit">Confirmer & Envoyer</button>
        <div id="msg" class="muted" style="margin-top:8px"></div>
      </div>
    </form>

    <div class="footer center">© 2025 PHENO&CO. Tous droits réservés.</div>
  </div>

  <!-- EmailJS (clé publique + service Gmail déjà intégrés) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    // === CONFIG ===
    const ADMIN_EMAIL = "location.phenoandco@gmail.com";
    const SERVICE_ID   = "service_llizndy";
    const PUBLIC_KEY   = "ufHEQuZ93VPkUtFId";
    const TEMPLATE_ID  = "template_reservation"; // si absent, on fera un fallback "mailto"

    emailjs.init(PUBLIC_KEY);

    // === UI ===
    const f = document.getElementById('locForm');
    const btnReserve = document.getElementById('btnReserve');
    const startHourSel = document.getElementById('start_hour');
    const hoursPerDaySel = document.getElementById('hours_per_day');
    const typeSel = document.getElementById('type_location');
    const shortWrap = document.getElementById('short_wrap');
    const longWrap  = document.getElementById('long_wrap');
    const shortFormula = document.getElementById('short_formula');
    const longFormula  = document.getElementById('long_formula');
    const msg = document.getElementById('msg');

    // Totaux
    const t_ht = id('t_ht'), t_tva=id('t_tva'), t_ttc=id('t_ttc'),
          t_acompte=id('t_acompte'), t_solde=id('t_solde'), t_redev=id('t_redev'),
          t_final=id('t_final'), t_days=id('t_days'), cgvText=id('cgvText');

    function id(x){return document.getElementById(x)}

    // Toggle formulaire
    btnReserve.addEventListener('click', () => f.classList.toggle('hide'));

    // Heure d’arrivée (10 → 18)
    for(let h=10; h<=18; h++){
      const val = String(h).padStart(2,'0')+":00";
      startHourSel.insertAdjacentHTML('beforeend', `<option value="${val}">${val}</option>`);
    }
    // Heures par jour (1 → 10)
    for(let h=1; h<=10; h++){
      hoursPerDaySel.insertAdjacentHTML('beforeend', `<option value="${h}">${h}h</option>`);
    }

    // Période par défaut : aujourd’hui + aujourd’hui
    const today = new Date().toISOString().slice(0,10);
    id('date_start').value = today;
    id('date_end').value   = today;

    // Changement type formule
    typeSel.addEventListener('change', () => {
      const isLong = typeSel.value === 'long';
      longWrap.classList.toggle('hide', !isLong);
      shortWrap.classList.toggle('hide', isLong);
      calc();
    });

    // Recalculs
    ['change','input'].forEach(ev=>{
      f.addEventListener(ev, (e)=>{ if(e.target.matches('input,select')) calc(); });
    });

    function daysBetween(d1, d2){
      const a = new Date(d1), b = new Date(d2);
      const diff = Math.round((b - a) / 86400000) + 1; // inclusif
      return Math.max(diff,1);
    }

    function val(sel){ return Number(sel.options[sel.selectedIndex]?.dataset?.ht || 0) }

    function calc(){
      const isLong = typeSel.value === 'long';
      const dStart = id('date_start').value;
      const dEnd   = id('date_end').value;
      const nbDays = daysBetween(dStart, dEnd);

      // Base HT selon formule
      let baseHT = 0;
      if(!isLong){
        const sel = shortFormula.value;
        const ht = val(shortFormula);
        switch(sel){
          case '1h': baseHT = 10 * Number(hoursPerDaySel.value) * nbDays / 1; break;
          case '4h': baseHT = 45 * nbDays; break;
          case '8h': baseHT = 70 * nbDays; break;
          case '5d': baseHT = 280 * Math.ceil(nbDays/5); break;
          default: baseHT = ht * nbDays;
        }
      }else{
        const htDay = val(longFormula);           // tarif/jour HT (65/60/55/50)
        baseHT = htDay * nbDays;                  // prix total HT période choisie
      }

      // Matériels / packs (par jour)
      const m = {
        clipper:  10 * Number(f.m_clipper.value),
        trimmer:   8 * Number(f.m_trimmer.value),
        shaver:    6 * Number(f.m_shaver.value),
        dryer:     8 * Number(f.m_dryer.value),
        towels:    4 * Number(f.m_towels.value),
        cape:      1 * Number(f.m_cape.value),
        pEss: Number(f.pack_essentiel.value),
        pPrem:Number(f.pack_premium.value),
      };
      const matsDayHT = m.clipper + m.trimmer + m.shaver + m.dryer + m.towels + m.cape + m.pEss + m.pPrem;
      const matsHT = matsDayHT * nbDays;

      const HT = Math.max(baseHT + matsHT, 0);
      const TVA = +(HT * 0.20).toFixed(2);
      const TTC = +(HT + TVA).toFixed(2);

      // Acomptes + redevance
      let acompte = 0, solde = 0, redev = 0, finalTTC = TTC, eqDays = '—';
      if(!isLong){
        acompte = +(TTC * 0.50).toFixed(2);
        solde   = +(TTC - acompte).toFixed(2);
        redev   = 0;
        finalTTC = TTC;
        // équivalence (approximative)
        if(shortFormula.value==='4h') eqDays = '≈ 2h déjà réglées';
        else if(shortFormula.value==='8h') eqDays = '≈ ½ journée déjà réglée';
        else if(shortFormula.value==='5d') eqDays = '≈ 2–3 jours déjà réglés';
        else eqDays = '≈ ½ journée déjà réglée';
      }else{
        acompte = +(TTC * 0.25).toFixed(2);
        solde   = +(TTC - acompte).toFixed(2);
        redev   = +(solde * 0.02).toFixed(2);
        finalTTC = +(TTC + redev).toFixed(2);
        // équivalence simple
        const htDay = val(longFormula);
        const ttcDay = +(htDay * 1.20).toFixed(2);
        eqDays = `≈ ${Math.max(1, Math.round(acompte/ttcDay))} jours déjà réglés`;
      }

      // Inject UI
      t_ht.textContent   = euro(HT);
      t_tva.textContent  = euro(TVA);
      t_ttc.textContent  = euro(TTC);
      t_acompte.textContent = euro(acompte);
      t_solde.textContent   = euro(solde);
      t_redev.textContent   = isLong ? euro(redev) : "—";
      t_final.textContent   = euro(finalTTC);
      t_days.textContent    = eqDays;

      // CGV dynamique (résumé)
      cgvText.textContent =
`Objet : location de fauteuil et matériels au salon PHENO&CO (18 rue d’Alger, Montpellier).
Période : du ${formatDate(dStart)} au ${formatDate(dEnd)} (≈ ${nbDays} jour(s)).
Heure d’arrivée : ${f.start_hour.value} • Heures/jour : ${f.hours_per_day.value}h
Formule : ${isLong ? label(longFormula) : label(shortFormula)}
Matériels : clipper x${f.m_clipper.value}, trimmer x${f.m_trimmer.value}, shaver x${f.m_shaver.value}, sèche-cheveux x${f.m_dryer.value}, serviettes x${f.m_towels.value}, cape x${f.m_cape.value}, Pack Essentiel ${f.pack_essentiel.value==='0'?'non':'oui'}, Pack Premium ${f.pack_premium.value==='0'?'non':'oui'}.

Tarifs : HT ${euro(HT)} • TVA 20% ${euro(TVA)} • TTC ${euro(TTC)}
Acompte : ${!isLong?'50% TTC':'25% TTC'} = ${euro(acompte)} • Solde TTC ${euro(solde)} ${isLong?`• Redevance 2% (appliquée sur solde) ${euro(redev)}`:''}
TOTAL TTC FINAL : ${euro(finalTTC)} • Équiv. jours réglés : ${eqDays}

Obligations locataire : hygiène/sécurité, assurance RC Pro, usage conforme, pas de sous-location.
Obligations bailleur  : mise à disposition du poste, maintenance lourde, sécurité.
Annulation : courte durée ≤48h : acompte non remboursé mais reportable une fois. Longue durée : préavis 1 mois (hors faute grave).
Litiges : médiation amiable puis tribunaux de Montpellier.`;

      return {HT,TVA,TTC,acompte,solde,redev,finalTTC,nbDays,isLong};
    }

    function euro(n){ return (Number(n)||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}) }
    function label(sel){ return sel.options[sel.selectedIndex].text }
    function formatDate(d){ return new Date(d+"T00:00:00").toLocaleDateString('fr-FR') }

    // Envoi email (EmailJS + fallback mailto)
    async function sendMail(e){
      e.preventDefault();
      msg.textContent = "Envoi en cours…";
      const totals = calc();

      const params = {
        to_admin: ADMIN_EMAIL,
        to_client: f.email.value,
        subject: "PHENO&CO – Demande de location de fauteuil",
        full_name: f.full_name.value,
        phone: f.phone.value,
        date_start: f.date_start.value,
        date_end: f.date_end.value,
        start_hour: f.start_hour.value,
        hours_per_day: f.hours_per_day.value,
        type_location: typeSel.value === 'long' ? 'Longue durée' : 'Courte durée',
        formula: typeSel.value==='long' ? label(longFormula) : label(shortFormula),
        mats: `clipper x${f.m_clipper.value}, trimmer x${f.m_trimmer.value}, shaver x${f.m_shaver.value}, sèche-cheveux x${f.m_dryer.value}, serviettes x${f.m_towels.value}, cape x${f.m_cape.value}, Pack Essentiel ${f.pack_essentiel.value==='0'?'non':'oui'}, Pack Premium ${f.pack_premium.value==='0'?'non':'oui'}`,
        total_ht: euro(totals.HT),
        total_tva: euro(totals.TVA),
        total_ttc: euro(totals.TTC),
        acompte: euro(totals.acompte),
        solde: euro(totals.solde),
        redev: totals.isLong ? euro(totals.redev) : "—",
        total_final: euro(totals.finalTTC),
        cgv: document.getElementById('cgvText').textContent
      };

      // Tentative EmailJS (si ton template existe)
      try{
        const r = await emailjs.send(SERVICE_ID, TEMPLATE_ID, params, PUBLIC_KEY);
        if(r.status===200){
          msg.textContent = "✅ Envoyé ! Une copie a été adressée à vous et au client.";
          f.reset(); calc();
          return;
        }
        throw new Error("Code "+r.status);
      }catch(err){
        // Fallback : mailto (pré-rempli)
        const body = encodeURIComponent(
`Demande de location – ${params.full_name} (${params.phone})
Période : ${formatDate(params.date_start)} → ${formatDate(params.date_end)}
Heure d’arrivée : ${params.start_hour} • Heures/jour : ${params.hours_per_day}
Type / Formule : ${params.type_location} – ${params.formula}
Matériels : ${params.mats}

HT ${params.total_ht} • TVA ${params.total_tva} • TTC ${params.total_ttc}
Acompte ${params.acompte} • Solde ${params.solde} • Redevance ${params.redev}
TOTAL TTC FINAL : ${params.total_final}

CGV :
${params.cgv}
`);
        const subject = encodeURIComponent("PHENO&CO – Demande de location de fauteuil");
        window.location.href = `mailto:${ADMIN_EMAIL}?cc=${encodeURIComponent(params.to_client)}&subject=${subject}&body=${body}`;
        msg.textContent = "ℹ️ EmailJS indisponible : bascule en envoi mail classique (pré-rempli).";
      }
    }

    // Premier calcul pour hydrater les totaux + CGV
    calc();
  </script>
</body>
</html>
