<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PHENO&CO — Barbershop depuis 2009</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#000;--fg:#fff;--muted:#bdbdbd;--yellow:#ffd400;--grey:#3a3a3a;--card:#0f0f0f;--line:#1f1f1f;--green:#25D366;--focus:#ffd400;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow-x:hidden}
  .wrap{max-width:920px;margin:0 auto;padding:0 16px 70px}
  header{padding:28px 16px 8px;text-align:center}
  header img{width:160px;max-width:46vw;display:block;margin:0 auto 6px}
  h1{margin:6px 0 2px;font-size:32px;line-height:1.1;color:var(--yellow);letter-spacing:.3px}
  .sub{margin:0;color:#ddd;font-size:14px}
  .sub.addr{opacity:.9}

  /* NAV boutons style app */
  .nav{display:flex;flex-direction:column;gap:16px;align-items:center;justify-content:center;margin:18px auto 18px}
  .btn{display:block;width:94%;max-width:560px;padding:18px 22px;border-radius:18px;font-weight:800;text-decoration:none;font-size:17px;line-height:1.2;border:1px solid #222;text-align:center;transition:.2s ease}
  .btn-yellow{background:var(--yellow);color:#000}
  .btn-grey{background:#2f2f2f;color:#fff}
  .btn-green{background:var(--green);color:#000}
  .btn:hover{transform:translateY(-1px);filter:drop-shadow(0 0 .25rem #ffd4004f)}
  .btn:focus-visible{outline:3px solid var(--focus);outline-offset:2px;filter:drop-shadow(0 0 .35rem #ffd4007a)}

  footer{padding:22px 18px;color:#aaa;font-size:.9rem;border-top:1px solid #111;text-align:center}

  /* Carte / sections form */
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px;margin:18px auto}
  .card h2{font-size:20px;margin:0 0 10px;color:#fff}
  .hint{font-size:12px;color:#9aa0a6}

  label{display:block;margin:10px 0 6px}
  input,select,textarea{width:100%;padding:14px 12px;border-radius:14px;border:1px solid #2a2a2a;background:#121212;color:#fff;font-size:16px}
  input:focus,select:focus,textarea:focus{border-color:#3a4148;box-shadow:0 0 0 3px #ffd40040;outline:none}
  input[type="date"]{color-scheme:dark}
  .row{display:grid;gap:12px}
  @media(min-width:680px){.row{grid-template-columns:1fr 1fr}}

  /* Accordéons compacts */
  details{background:#0c0c0c;border:1px solid #1e1e1e;border-radius:14px;padding:12px}
  details+details{margin-top:12px}
  details>summary{list-style:none;cursor:pointer;font-weight:800;display:flex;align-items:center;justify-content:space-between}
  details>summary::-webkit-details-marker{display:none}
  .badge{display:inline-block;background:#222;border:1px solid #333;border-radius:999px;padding:2px 8px;margin-left:8px;color:#ddd;font-size:12px}

  .summaryBox{border-top:1px dashed #2b2b2b;margin-top:14px;padding-top:12px;color:#e6e6e6}
  .summaryBox small{color:#bdbdbd}
  .actions{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap}
  .btn-submit,.btn-reset{flex:1;min-width:160px;padding:14px 16px;border-radius:14px;border:none;font-weight:800;cursor:pointer}
  .btn-submit{background:var(--yellow);color:#000}
  .btn-reset{background:var(--grey);color:#fff}

  .status{position:fixed;right:8px;bottom:8px;font-size:12px;background:#0f0f0f;border:1px solid #222;color:#9eea9e;padding:6px 8px;border-radius:8px;opacity:.85}

  /* Modal CGV simple (ancre CSS) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:18px;z-index:99}
  .modal:target{display:flex}
  .box{max-width:980px;width:100%;background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px;max-height:88vh;overflow:auto;text-align:left}
  .box h3{color:var(--yellow);margin:0 0 10px}
  .box h4{margin:14px 0 8px}
  .box p,.box li{color:#ddd}
  .box ul{margin:0 0 8px 18px}
  .close{display:inline-block;margin-top:12px;padding:10px 14px;background:#161616;border:1px solid #2a2a2a;border-radius:10px;color:#fff;text-decoration:none}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="1.png" alt="Logo PHENO&CO" onerror="this.style.display='none'">
      <h1>PHENO&CO</h1>
      <p class="sub">Barbershop • Depuis 2009 • Montpellier</p>
      <p class="sub addr">18 Rue d'Alger, 34000 Montpellier</p>
    </header>

    <nav class="nav" aria-label="Actions principales">
      <a class="btn btn-yellow" href="#form">Réserver Fauteuil</a>
      <a class="btn btn-grey" href="https://phenoandco.com" target="_blank" rel="noopener">Prendre RDV Coiffure</a>
      <a class="btn btn-green" href="https://wa.me/33769432605" target="_blank" rel="noopener">Contact WhatsApp</a>
    </nav>

    <!-- ===== Formulaire compact style app ===== -->
    <section id="form" class="card" aria-labelledby="t-form">
      <h2 id="t-form">Réservation</h2>
      <p class="hint">Choisis tes dates (calendrier), ta formule (courte OU longue durée), puis le matériel si besoin. Les totaux et le contrat s’affichent automatiquement.</p>

      <form id="rentForm" autocomplete="on" novalidate>
        <!-- Infos -->
        <details open>
          <summary>Vos informations <span class="badge">obligatoire</span></summary>
          <div class="row" style="margin-top:10px">
            <div><label for="f-name">Nom complet *</label><input id="f-name" required placeholder="Votre nom et prénom"></div>
            <div><label for="f-email">Email *</label><input id="f-email" required inputmode="email" placeholder="votre.email@exemple.fr"></div>
          </div>
          <div class="row">
            <div><label for="f-phone">Téléphone *</label><input id="f-phone" required inputmode="tel" placeholder="06 12 34 56 78"></div>
            <div><label for="f-note">Commentaire (optionnel)</label><input id="f-note" placeholder="Ex. poste demandé, shaver…"></div>
          </div>
        </details>

        <!-- Dates & heures -->
        <details open>
          <summary>Dates de location <span class="badge">calendrier</span></summary>
          <div class="row" style="margin-top:10px">
            <div>
              <label for="f-start-date">Date de début</label>
              <input type="date" id="f-start-date">
            </div>
            <div>
              <label for="f-end-date">Date de fin</label>
              <input type="date" id="f-end-date">
            </div>
          </div>
          <div class="row">
            <div>
              <label for="f-start-time">Heure d’arrivée (10:00–18:00)</label>
              <select id="f-start-time">
                <option>10:00</option><option>11:00</option><option>12:00</option><option>13:00</option>
                <option>14:00</option><option>15:00</option><option>16:00</option><option>17:00</option><option>18:00</option>
              </select>
            </div>
            <div>
              <label for="f-hours-per-day">Nombre d’heures par jour</label>
              <select id="f-hours-per-day">
                <option>1</option><option>2</option><option>3</option><option selected>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
              </select>
            </div>
          </div>
        </details>

        <!-- Formules -->
        <details open>
          <summary>Formule <span class="badge">tarifs HT</span></summary>
          <div class="row" style="margin-top:10px">
            <div>
              <label for="formula-short">Courte durée (si choisie, l’autre se désactive)</label>
              <select id="formula-short">
                <option value="">— Choisir —</option>
                <option value="hour">À l’heure — 10 € HT</option>
                <option value="halfday">½ journée (4h) — 45 € HT</option>
                <option value="fullday">1 journée (8h) — 70 € HT</option>
                <option value="week">1 semaine (5 jours) — 280 € HT</option>
              </select>
            </div>
            <div>
              <label for="formula-long">Longue durée (€/jour HT)</label>
              <select id="formula-long">
                <option value="">— Choisir —</option>
                <option value="m1">1 mois — 65 € / jour (HT) + redevance 2%</option>
                <option value="m3">3 mois — 60 € / jour (HT) + redevance 2%</option>
                <option value="m6">6 mois — 55 € / jour (HT) + redevance 2%</option>
                <option value="m12">12 mois — 50 € / jour (HT) + redevance 2%</option>
              </select>
              <div class="hint">Calcul basé sur 20 jours ouvrés/mois. La redevance 2% est appliquée sur le solde TTC (après acompte) et affichée plus bas.</div>
            </div>
          </div>
        </details>

        <!-- Matériel (replié) -->
        <details>
          <summary>Pack matériel (optionnel) <span class="badge">par jour</span></summary>
          <div class="row" style="margin-top:10px">
            <div>
              <label for="q-clipper">Tondeuse classique — 10 €</label>
              <select id="q-clipper"><option value="0" selected>0</option><option>1</option><option>2</option><option>3</option></select>
            </div>
            <div>
              <label for="q-trimmer">Tondeuse finition — 8 €</label>
              <select id="q-trimmer"><option value="0" selected>0</option><option>1</option><option>2</option><option>3</option></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="q-shaver">Shaver — 6 €</label>
              <select id="q-shaver"><option value="0" selected>0</option><option>1</option><option>2</option><option>3</option></select>
            </div>
            <div>
              <label for="q-dryer">Sèche-cheveux — 8 €</label>
              <select id="q-dryer"><option value="0" selected>0</option><option>1</option><option>2</option><option>3</option></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="q-cape">Cape — 1 €</label>
              <select id="q-cape"><option value="0" selected>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select>
            </div>
            <div>
              <label for="q-towel">Serviettes (lot de 4) — 4 €</label>
              <select id="q-towel"><option value="0" selected>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select>
            </div>
          </div>
          <div class="row">
            <div>
              <label for="q-pack-ess">Pack Essentiel — 20 €</label>
              <select id="q-pack-ess"><option value="0" selected>0</option><option>1</option></select>
              <div class="hint">1 classique, 1 finition, 2 serviettes, 1 cape</div>
            </div>
            <div>
              <label for="q-pack-prem">Pack Premium — 30 €</label>
              <select id="q-pack-prem"><option value="0" selected>0</option><option>1</option></select>
              <div class="hint">1 classique, 1 finition, 1 shaver, 4 serviettes, 2 capes</div>
            </div>
          </div>
        </details>

        <!-- Récap + CGV -->
        <label style="display:flex;align-items:center;gap:8px;margin-top:12px">
          <input type="checkbox" id="f-cgv" required>
          <span>J’accepte les <a href="#cgv" style="color:#8ab4f8">conditions générales de vente</a>.</span>
        </label>

        <div class="summaryBox">
          <div><small>Période :</small> <span id="sum-period">—</span></div>
          <div><small>Formule :</small> <span id="sum-formula">—</span> <span class="badge" id="sum-mode">—</span></div>
          <div><small>Heures/jour :</small> <span id="sum-hpd">0</span></div>
          <div><small>Matériel HT :</small> <span id="sum-gear">0 €</span></div>

          <div style="margin-top:8px"><small><b>Loyer</b> :</small></div>
          <div><small>Total HT :</small> <span id="sum-ht">0 €</span></div>
          <div><small>TVA 20% :</small> <span id="sum-tva">0 €</span></div>
          <div><b>Total TTC (loyer) :</b> <span id="sum-ttc">0 €</span></div>

          <div style="margin-top:8px"><small><b>Acompte</b> :</small> <span id="sum-deposit-rate">—</span></div>
          <div><small>Acompte TTC :</small> <span id="sum-deposit">0 €</span> • <small>Équiv. couvert :</small> <span id="sum-equivalence">—</span></div>

          <div id="fee-block" style="margin-top:8px;display:none">
            <div><small><b>Solde TTC :</b></small> <span id="sum-soldettc">0 €</span></div>
            <div><small><b>Redevance 2% :</b></small> <span id="sum-fee-detail">—</span></div>
            <div><small><b>TTC/jour final :</b></small> <span id="sum-ttc-perday-final">—</span></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn-submit" type="submit">Confirmer & envoyer (WhatsApp)</button>
          <button class="btn-reset" type="reset" id="resetBtn">Effacer</button>
          <a id="emailLink" class="btn btn-grey" href="#" target="_blank" rel="noopener">Envoyer aussi par e-mail</a>
        </div>
      </form>
    </section>

    <footer>© 2025 PHENO&CO. Tous droits réservés.</footer>
  </div>

  <!-- ===== CGV (détaillées + récap dynamique) ===== -->
  <div class="modal" id="cgv" aria-hidden="true">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="cgvTitle">
      <h3 id="cgvTitle">CGV – PHENO&CO (contrat & récap)</h3>

      <h4>Récapitulatif</h4>
      <p><b>Nom :</b> <span id="cv-name">—</span> • <b>Téléphone :</b> <span id="cv-phone">—</span> • <b>Email :</b> <span id="cv-email">—</span></p>
      <p><b>Période :</b> <span id="cv-period">—</span> • <b>Heures/jour :</b> <span id="cv-hpd">—</span></p>
      <p><b>Formule :</b> <span id="cv-formula">—</span> <span class="badge" id="cv-mode">—</span></p>
      <p><b>Matériel sélectionné :</b> <span id="cv-gear-list">—</span></p>
      <p><b>Total loyer HT :</b> <span id="cv-ht">0 €</span> • <b>TVA 20% :</b> <span id="cv-tva">0 €</span> • <b>Total TTC (loyer) :</b> <span id="cv-ttc">0 €</span></p>
      <p><b>Acompte (<span id="cv-deposit-rate">—</span>) :</b> <span id="cv-deposit">0 €</span> • <b>Équiv. couvert :</b> <span id="cv-equivalence">—</span></p>
      <div id="cv-fee-block" style="display:none">
        <p><b>Solde TTC :</b> <span id="cv-soldettc">0 €</span></p>
        <p><b>Redevance 2% :</b> <span id="cv-fee-detail">—</span></p>
        <p><b>TTC/jour final (loyer + redevance) :</b> <span id="cv-ttc-perday-final">—</span></p>
      </div>

      <h4>Conditions Générales de Vente et de Location</h4>
      <ul>
        <li><b>Objet :</b> mise à disposition d’un fauteuil et, le cas échéant, de matériels complémentaires au salon PHENO&CO (18 rue d’Alger, Montpellier). Validation = contrat.</li>
        <li><b>Tarifs :</b> courte durée (heure, ½ journée, journée, semaine) ; longue durée (1/3/6/12 mois) affichée en €/jour HT. Les montants TTC et totaux sont calculés automatiquement.</li>
        <li><b>Acomptes :</b> courte durée = 50% TTC ; longue durée = 25% TTC. Les acomptes sont des loyers payés d’avance et déductibles du solde.</li>
        <li><b>Paiement :</b> lien électronique/WhatsApp, virement, espèces/chèque. Solde : fin de prestation (courte) / fin de mois (longue).</li>
        <li><b>Redevance 2% (longue durée) :</b> appliquée mensuellement sur le <i>solde TTC</i> après acompte. Correspond à l’accès à l’espace personnel (planning client).</li>
        <li><b>Obligations locataire :</b> hygiène/sécurité, usage conforme, RC Pro, sincérité du CA, pas de sous-location sans accord écrit.</li>
        <li><b>Obligations bailleur :</b> mise à disposition conforme, sécurité, maintenance lourde (électricité, plomberie, mobilier), confidentialité.</li>
        <li><b>Annulation :</b> courte durée ≤48h : acompte non remboursé mais reportable 1 fois. Longue durée : préavis 1 mois sauf faute grave.</li>
        <li><b>Assurances & responsabilité :</b> le bailleur couvre le local ; chaque locataire reste responsable de son activité professionnelle et de ses dommages.</li>
        <li><b>Litiges :</b> médiation amiable puis tribunaux de Montpellier.</li>
      </ul>

      <a href="#" class="close">Fermer</a>
    </div>
  </div>

  <!-- Statut debug -->
  <div class="status" id="status">OK</div>

<script>
/* ===== CONFIG ===== */
const PHONE='33769432605';
const EMAIL='location.phenoandco@gmail.com';
const TVA=0.20;
const WORK_DAYS_PER_MONTH=20;

/* Tarifs (HT) */
const SHORT_PRICES = {
  hour:     { label:'À l’heure',            pricePerHour: 10 },
  halfday:  { label:'½ journée (4h)',       fixedPerBlock: 45, hoursPerDay: 4 },
  fullday:  { label:'1 journée (8h)',       fixedPerBlock: 70, hoursPerDay: 8 },
  week:     { label:'1 semaine (5 jours)',  fixedPerBlock: 280, daysPerBlock: 5 }
};
const LONG_PRICES = {
  m1:  { label:'1 mois',   months:1,  perDay:65 },
  m3:  { label:'3 mois',   months:3,  perDay:60 },
  m6:  { label:'6 mois',   months:6,  perDay:55 },
  m12: { label:'12 mois',  months:12, perDay:50 }
};
const GEAR = [
  { id:'q-clipper',   label:'Tondeuse classique',       price:10 },
  { id:'q-trimmer',   label:'Tondeuse finition',        price:8  },
  { id:'q-shaver',    label:'Shaver',                   price:6  },
  { id:'q-dryer',     label:'Sèche-cheveux',            price:8  },
  { id:'q-cape',      label:'Cape',                     price:1  },
  { id:'q-towel',     label:'Serviettes (lot de 4)',    price:4  },
  { id:'q-pack-ess',  label:'Pack Essentiel',           price:20 },
  { id:'q-pack-prem', label:'Pack Premium',             price:30 },
];

const fmt = new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});
const $ = (id)=>document.getElementById(id);
function pad2(v){return String(v).padStart(2,'0');}
function todayYMD(){ const t=new Date(); return `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`; }
function parseDate(value){ return value? new Date(`${value}T00:00:00`) : null; }
function daysInclusive(a,b){ const A=new Date(a.getFullYear(),a.getMonth(),a.getDate()); const B=new Date(b.getFullYear(),b.getMonth(),b.getDate()); return Math.max(1, Math.floor((B-A)/86400000)+1); }
function periodText(a,b,arr){ const s=`${pad2(a.getDate())}/${pad2(a.getMonth()+1)}/${a.getFullYear()}`, e=`${pad2(b.getDate())}/${pad2(b.getMonth()+1)}/${b.getFullYear()}`; return `${s} → ${e} (arrivée ${arr})`; }

/* Elements */
const fStartDate=$('f-start-date'), fEndDate=$('f-end-date');
const fName=$('f-name'), fPhone=$('f-phone'), fEmail=$('f-email'), fNote=$('f-note');
const startTime=$('f-start-time'), hpd=$('f-hours-per-day');
const fs=$('formula-short'), fl=$('formula-long');
const statusEl=$('status');

/* Init */
(function init(){
  const t=todayYMD(); fStartDate.value=t; fEndDate.value=t;
  startTime.value='10:00'; hpd.value='4';
  updateAll();
})();

/* Formule exclusive + heures auto */
function lockFormulas(e){
  if(e.target===fs && fs.value){ fl.value=''; fl.disabled=true; }
  else if(e.target===fl && fl.value){ fs.value=''; fs.disabled=true; }
  if(!fs.value && !fl.value){ fs.disabled=false; fl.disabled=false; }
  if(fs.value==='halfday'){ hpd.value='4'; hpd.disabled=true; }
  else if(fs.value==='fullday'){ hpd.value='8'; hpd.disabled=true; }
  else if(!fl.value){ hpd.disabled=false; }
  updateAll();
}
fs.addEventListener('change',lockFormulas);
fl.addEventListener('change',lockFormulas);

/* Coût matériel (par jour ouvré) */
function gearCost(months, days){
  let perDay=0; const labels=[];
  GEAR.forEach(g=>{ const q = Number($(g.id).value||0); if(q>0){ perDay+=g.price*q; labels.push(`${g.label} x${q}`); }});
  const mult = months>0 ? (WORK_DAYS_PER_MONTH*months) : Math.max(1, days);
  return { cost: perDay*mult, labels };
}

/* Aide équivalence acompte côté courte durée */
function shortTtcUnit(fsKey){
  if(fsKey==='hour'){ return 10*1.20; }               // 12 €/h
  if(fsKey==='halfday'){ return (45*1.20)/4; }        // 13.5 €/h
  if(fsKey==='fullday'){ return 70*1.20; }            // 84 €/jour
  if(fsKey==='week'){ return (280*1.20)/5; }          // 67.2 €/jour
  return 0;
}

function compute(){
  let sd=parseDate(fStartDate.value) || new Date();
  let ed=parseDate(fEndDate.value) || sd;
  if(ed<sd) ed=sd;
  const days = daysInclusive(sd,ed);
  const hoursPerDay = Number(hpd.value||0);

  let mode='—', months=0, formulaLabel='—', baseHt=0, autoEnd='';
  // Courte durée
  if(fs.value){
    mode='Courte durée';
    const k=fs.value, def=SHORT_PRICES[k];
    formulaLabel=def.label;
    if(k==='hour'){ baseHt=(days*hoursPerDay)*SHORT_PRICES.hour.pricePerHour; }
    else if(k==='halfday'){ baseHt=days*def.fixedPerBlock; }
    else if(k==='fullday'){ baseHt=days*def.fixedPerBlock; }
    else if(k==='week'){ const weeks=Math.ceil((days||0)/def.daysPerBlock); baseHt=weeks*def.fixedPerBlock; }
  }
  // Longue durée
  else if(fl.value){
    mode='Longue durée';
    const def=LONG_PRICES[fl.value];
    months=def.months;
    formulaLabel=`${def.label} — ${def.perDay} € / jour (HT) + redevance 2%`;
    baseHt=def.perDay*WORK_DAYS_PER_MONTH*def.months;
    const end=new Date(sd.getFullYear(), sd.getMonth()+def.months, sd.getDate());
    autoEnd=` (fin approx. ${pad2(end.getDate())}/${pad2(end.getMonth()+1)}/${end.getFullYear()})`;
  }

  const gear=gearCost(months, days);

  // Loyer
  const totalHt = baseHt + gear.cost;
  const tva = totalHt*TVA;
  const ttc = totalHt + tva;

  // Acompte
  const depositRate = (mode==='Longue durée') ? 0.25 : 0.50;
  const depositTtc = ttc*depositRate;
  const soldeTtc = ttc - depositTtc;

  // Redevance
  let fee = 0;
  if(mode==='Longue durée'){ fee = soldeTtc * 0.02; }
  const finalTtc = ttc + fee;

  // TTC/jour final & équivalence acompte
  let ttcPerDayFinal = null, equivalenceText='—';
  if(mode==='Longue durée'){
    const totalDays = WORK_DAYS_PER_MONTH * Math.max(1, months);
    ttcPerDayFinal = finalTtc / totalDays;
    const daysCovered = depositTtc / ttcPerDayFinal;
    equivalenceText = `≈ ${daysCovered.toFixed(1)} jour(s) couverts`;
  } else if(mode==='Courte durée' && fs.value){
    const k=fs.value;
    const unit = shortTtcUnit(k);
    if(k==='hour' || k==='halfday'){
      const hoursCovered = depositTtc / unit;
      equivalenceText = `≈ ${hoursCovered.toFixed(1)} h couvertes`;
    } else {
      const perDayTtc = (k==='fullday') ? unit : shortTtcUnit('week'); // 84 ou 67.2
      const daysCovered = depositTtc / perDayTtc;
      equivalenceText = `≈ ${daysCovered.toFixed(1)} jour(s) couverts`;
    }
  }

  return { sd, ed, days, hoursPerDay, mode, months, formulaLabel, baseHt, gearList:gear.labels, gearHt:gear.cost,
           totalHt, tva, ttc, depositRate, depositTtc, soldeTtc, fee, finalTtc, ttcPerDayFinal, autoEnd, equivalenceText };
}

function updateAll(){
  try{
    const c=compute();
    const period = periodText(c.sd,c.ed,$('f-start-time').value) + (c.autoEnd||'');

    // Résumé
    $('sum-period').textContent = period;
    $('sum-formula').textContent = c.formulaLabel;
    $('sum-mode').textContent    = c.mode;
    $('sum-hpd').textContent     = c.hoursPerDay;
    $('sum-gear').textContent    = fmt.format(c.gearHt);
    $('sum-ht').textContent      = fmt.format(c.totalHt);
    $('sum-tva').textContent     = fmt.format(c.tva);
    $('sum-ttc').textContent     = fmt.format(c.ttc);
    $('sum-deposit-rate').textContent = c.mode==='Longue durée' ? '25% TTC' : '50% TTC';
    $('sum-deposit').textContent = fmt.format(c.depositTtc);
    $('sum-equivalence').textContent = c.equivalenceText;

    const feeBlockVisible = (c.mode==='Longue durée');
    $('fee-block').style.display = feeBlockVisible ? 'block' : 'none';
    if(feeBlockVisible){
      $('sum-soldettc').textContent = fmt.format(c.soldeTtc);
      $('sum-fee-detail').textContent = `${fmt.format(c.fee)} (2% × ${fmt.format(c.soldeTtc)})`;
      $('sum-ttc-perday-final').textContent = c.ttcPerDayFinal ? fmt.format(c.ttcPerDayFinal) : '—';
    }

    // Email fallback
    const subject=encodeURIComponent(`Demande de location de fauteuil — ${fName.value||''}`);
    const body=encodeURIComponent(
`Demande de location — PHENO&CO
Nom: ${fName.value||'-'}
Téléphone: ${fPhone.value||'-'}
Email: ${fEmail.value||'-'}
Période: ${period}
Formule: ${c.mode} — ${c.formulaLabel}
Heures/jour: ${c.hoursPerDay}

Loyer:
  • Total HT: ${fmt.format(c.totalHt)}
  • TVA 20%: ${fmt.format(c.tva)}
  • Total TTC (loyer): ${fmt.format(c.ttc)}

Acompte (${c.mode==='Longue durée'?'25%':'50%'} TTC):
  • Acompte TTC: ${fmt.format(c.depositTtc)}
  • Équiv. couvert: ${c.equivalenceText}

${c.mode==='Longue durée' ?
`Longue durée — détails:
  • Solde TTC: ${fmt.format(c.soldeTtc)}
  • Redevance 2%: ${fmt.format(c.fee)} (2% × ${fmt.format(c.soldeTtc)})
  • TTC/jour final: ${c.ttcPerDayFinal?fmt.format(c.ttcPerDayFinal):'—'}` : ''}

Matériel: ${c.gearList.join(', ') || '-'}
CGV/Contrat: accepté si coché.`);
    $('emailLink').href=`mailto:${EMAIL}?subject=${subject}&body=${body}`;

    // CGV récap dynamique
    $('cv-name').textContent   = fName.value||'—';
    $('cv-phone').textContent  = fPhone.value||'—';
    $('cv-email').textContent  = fEmail.value||'—';
    $('cv-period').textContent = period;
    $('cv-hpd').textContent    = c.hoursPerDay||'—';
    $('cv-formula').textContent= c.formulaLabel||'—';
    $('cv-mode').textContent   = c.mode||'—';
    $('cv-gear-list').textContent = (c.gearList.length? c.gearList.join(', ') : '—');

    $('cv-ht').textContent     = fmt.format(c.totalHt);
    $('cv-tva').textContent    = fmt.format(c.tva);
    $('cv-ttc').textContent    = fmt.format(c.ttc);
    $('cv-deposit-rate').textContent = c.mode==='Longue durée' ? '25% TTC' : '50% TTC';
    $('cv-deposit').textContent  = fmt.format(c.depositTtc);
    $('cv-equivalence').textContent = c.equivalenceText;

    const cvFeeVis = (c.mode==='Longue durée');
    $('cv-fee-block').style.display = cvFeeVis ? 'block' : 'none';
    if(cvFeeVis){
      $('cv-soldettc').textContent = fmt.format(c.soldeTtc);
      $('cv-fee-detail').textContent = `${fmt.format(c.fee)} (2% × ${fmt.format(c.soldeTtc)})`;
      $('cv-ttc-perday-final').textContent = c.ttcPerDayFinal? fmt.format(c.ttcPerDayFinal) : '—';
    }

    statusEl.textContent='OK'; statusEl.style.color='#9eea9e';
  }catch(err){
    statusEl.textContent='ERREUR: '+(err.message||err); statusEl.style.color='#ff7b7b';
    console.error(err);
  }
}

/* Listeners */
['input','change'].forEach(evt=>{
  [fStartDate,fEndDate,fName,fPhone,fEmail,fNote,startTime,hpd,fs,fl]
    .forEach(el=>el.addEventListener(evt,updateAll));
  GEAR.forEach(g=>$(g.id).addEventListener('change',updateAll));
});

/* Reset */
$('resetBtn').onclick=()=>setTimeout(()=>{
  const t=todayYMD(); fStartDate.value=t; fEndDate.value=t;
  fName.value=''; fPhone.value=''; fEmail.value=''; fNote.value='';
  startTime.value='10:00'; hpd.value='4';
  fs.value=''; fl.value=''; fs.disabled=false; fl.disabled=false; hpd.disabled=false;
  GEAR.forEach(g=>$(g.id).value='0');
  updateAll();
},0);

/* Submit => WhatsApp */
$('rentForm').addEventListener('submit',(e)=>{
  e.preventDefault();
  if(!(fName.value.trim() && fPhone.value.trim() && fEmail.value.trim())){ alert('Merci de renseigner nom, téléphone et email.'); return; }
  if(!$('f-cgv').checked){ alert('Merci d’accepter les CGV (clique pour lire).'); return; }
  if(!fs.value && !fl.value){ alert('Choisis une formule (courte OU longue durée).'); return; }

  const c=compute();
  const msg =
`Demande de location — PHENO&CO
• Nom: ${fName.value.trim()}
• Tel: ${fPhone.value.trim()} • Email: ${fEmail.value.trim()}
• Période: ${periodText(c.sd,c.ed,$('f-start-time').value)}${c.autoEnd||''}
• Formule: ${c.mode} — ${c.formulaLabel}
• Heures/jour: ${c.hoursPerDay}

Loyer:
• Total HT: ${fmt.format(c.totalHt)} • TVA: ${fmt.format(c.tva)} • Total TTC: ${fmt.format(c.ttc)}

Acompte (${c.mode==='Longue durée'?'25%':'50%'} TTC):
• Acompte TTC: ${fmt.format(c.depositTtc)} • Équiv.: ${c.equivalenceText}

${c.mode==='Longue durée' ? 
`Longue durée — détails:
• Solde TTC: ${fmt.format(c.soldeTtc)}
• Redevance 2%: ${fmt.format(c.fee)} (2% × ${fmt.format(c.soldeTtc)})
• TTC/jour final: ${c.ttcPerDayFinal?fmt.format(c.ttcPerDayFinal):'—'}` : ''}

Matériel: ${c.gearList.join(', ') || '-'}
CGV: accepté ✅`;
  window.open(`https://wa.me/${PHONE}?text=${encodeURIComponent(msg)}`,'_blank','noopener');
});

/* Premier rendu */
updateAll();
</script>
</body>
</html>
