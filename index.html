<script>
/* ===== CONFIG ===== */
const PHONE='33769432605';
const EMAIL='location.phenoandco@gmail.com';
const TVA=0.20;
const WORK_DAYS_PER_MONTH=20;

/* Courte durée (HT) */
const SHORT_PRICES = {
  hour:     { label:'1h',            pricePerHour: 10 },
  halfday:  { label:'½ journée (4h)', fixedPerBlock: 45, hoursPerDay: 4 },
  fullday:  { label:'1 journée (8h)', fixedPerBlock: 70, hoursPerDay: 8 },
  week:     { label:'1 semaine (5 jours)', fixedPerBlock: 280, daysPerBlock: 5 }
};
/* Longue durée (€/jour HT) */
const LONG_PRICES = {
  m1:  { label:'1 mois',   months:1,  perDay:65 },
  m3:  { label:'3 mois',   months:3,  perDay:60 },
  m6:  { label:'6 mois',   months:6,  perDay:55 },
  m12: { label:'12 mois',  months:12, perDay:50 }
};
/* Matériel (prix/jour HT) */
const GEAR = [
  { id:'q-clipper',   label:'Tondeuse classique',       price:10 },
  { id:'q-trimmer',   label:'Tondeuse finition',        price:8  },
  { id:'q-shaver',    label:'Shaver',                   price:6  },
  { id:'q-dryer',     label:'Sèche-cheveux',            price:8  },
  { id:'q-cape',      label:'Cape',                     price:1  },
  { id:'q-towel',     label:'Serviettes (lot de 4)',    price:4  },
  { id:'q-pack-ess',  label:'Pack Essentiel',           price:20 },
  { id:'q-pack-prem', label:'Pack Premium',             price:30 },
];

/* === Utilitaires === */
const fmt = new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});
const id=s=>document.getElementById(s);
function pad2(v){return String(v).padStart(2,'0');}

/* ==== Dates helpers ==== */
function todayYMD(){
  const t=new Date(); const y=t.getFullYear(), m=pad2(t.getMonth()+1), d=pad2(t.getDate());
  return `${y}-${m}-${d}`;
}
function parseDateInput(val){
  if(!val) return null;
  const d=new Date(`${val}T00:00:00`);
  return isNaN(d)? null : d;
}
function daysInclusive(a,b){
  const A=new Date(a.getFullYear(),a.getMonth(),a.getDate());
  const B=new Date(b.getFullYear(),b.getMonth(),b.getDate());
  return Math.max(1, Math.floor((B-A)/86400000)+1);
}
function ymdText(a,b,arrival){
  const s=`${a.getFullYear()}-${pad2(a.getMonth()+1)}-${pad2(a.getDate())}`;
  const e=`${b.getFullYear()}-${pad2(b.getMonth()+1)}-${pad2(b.getDate())}`;
  return `${s} → ${e} (arrivée ${arrival})`;
}

/* ==== Elements ==== */
const fStartDate=id('f-start-date'), fEndDate=id('f-end-date');
const fName=id('f-name'), fPhone=id('f-phone'), fEmail=id('f-email'), fNote=id('f-note');
const startTime=id('f-start-time'), hpd=id('f-hours-per-day');
const fs=id('formula-short'), fl=id('formula-long');
const caBlock=id('caBlock'), fCA=id('f-ca');

/* Init calendar defaults (aujourd’hui) */
(function initDates(){
  const t=todayYMD();
  fStartDate.value = t;
  fEndDate.value   = t;
})();

/* Exclusivité des formules */
function lockFormulas(e){
  if(e.target===fs && fs.value){ fl.value=''; fl.disabled=true; caBlock.style.display='none'; }
  else if(e.target===fl && fl.value){ fs.value=''; fs.disabled=true; hpd.disabled=false; caBlock.style.display='grid'; }
  if(!fs.value && !fl.value){ fs.disabled=false; fl.disabled=false; caBlock.style.display='none'; }
  if(fs.value==='halfday'){ hpd.value='4'; hpd.disabled=true; }
  else if(fs.value==='fullday'){ hpd.value='8'; hpd.disabled=true; }
  else { if(!fl.value) hpd.disabled=false; }
  updateAll();
}
fs.addEventListener('change',lockFormulas);
fl.addEventListener('change',lockFormulas);

/* Matériel → coût */
function gearCost(modeMonths, days){
  let perDay=0; const labels=[];
  GEAR.forEach(g=>{
    const q = Math.max(0, Number(id(g.id).value)||0);
    if(q>0){ perDay += g.price*q; labels.push(`${g.label} x${q}`); }
  });
  const mult = modeMonths>0 ? (WORK_DAYS_PER_MONTH*modeMonths) : Math.max(1, days);
  return { cost: perDay*mult, labels };
}

function compute(){
  // Dates
  let sd = parseDateInput(fStartDate.value) || new Date();
  let ed = parseDateInput(fEndDate.value) || sd;
  if(ed < sd) ed = sd; // sécurité
  const days = daysInclusive(sd, ed);

  const hoursPerDay = Number(hpd.value||0);
  let mode='—', months=0, formulaLabel='—', baseHt=0, autoEndText='';
  // Courte durée
  if(fs.value){
    mode='Courte durée';
    const key=fs.value, def=SHORT_PRICES[key];
    formulaLabel=def.label;
    if(key==='hour'){ baseHt = (days*hoursPerDay) * SHORT_PRICES.hour.pricePerHour; }
    else if(key==='halfday'){ baseHt = days * def.fixedPerBlock; }
    else if(key==='fullday'){ baseHt = days * def.fixedPerBlock; }
    else if(key==='week'){ const weeks = Math.ceil((days||0)/def.daysPerBlock); baseHt = weeks * def.fixedPerBlock; }
  }
  // Longue durée
  else if(fl.value){
    mode='Longue durée';
    const def=LONG_PRICES[fl.value];
    months = def.months;
    formulaLabel=`${def.label} — ${def.perDay} € / jour (HT) + redevance 2%/mois`;
    baseHt = def.perDay * WORK_DAYS_PER_MONTH * def.months;
    const end=new Date(sd.getFullYear(), sd.getMonth()+def.months, sd.getDate());
    autoEndText = ` (fin approx. ${end.getFullYear()}-${pad2(end.getMonth()+1)}-${pad2(end.getDate())})`;
  }
  // Matériel
  const gear = gearCost(months, days);
  const totalHt = baseHt + gear.cost;
  const tva = totalHt * TVA;
  const ttc = totalHt + tva;
  const deposit = ttc * 0.5;

  // Redevance (estimée) si CA fourni & mode long
  let feeEst=0;
  if(mode==='Longue durée' && fCA && fCA.value){
    const ca = Math.max(0, Number(fCA.value)||0);
    feeEst = ca * 0.02 * Math.max(1, months);
  }
  return { sd, ed, days, hoursPerDay, mode, months, formulaLabel, baseHt, gearList:gear.labels, gearHt:gear.cost, totalHt, tva, ttc, deposit, autoEndText, feeEst };
}

function updateAll(){
  const c=compute();
  const period = ymdText(c.sd,c.ed,startTime.value) + (c.autoEndText||'');
  id('sum-period').textContent = period;
  id('sum-formula').textContent = c.formulaLabel;
  id('sum-mode').textContent    = c.mode;
  id('sum-hpd').textContent     = c.hoursPerDay;
  id('sum-gear').textContent    = fmt.format(c.gearHt);
  id('sum-ht').textContent      = fmt.format(c.totalHt);
  id('sum-tva').textContent     = fmt.format(c.tva);
  id('sum-ttc').textContent     = fmt.format(c.ttc);
  id('sum-deposit').textContent = fmt.format(c.deposit);

  const showFee = (c.mode==='Longue durée');
  id('sum-fee-wrap').style.display = showFee ? 'block':'none';
  id('sum-fee').textContent = (showFee && c.feeEst>0) ? fmt.format(c.feeEst) : '—';

  const subject=encodeURIComponent(`Demande de location de fauteuil — ${fName.value||''}`);
  const body=encodeURIComponent(
`Demande de location — PHENO&CO
Nom: ${fName.value||'-'}
Téléphone: ${fPhone.value||'-'}
Email: ${fEmail.value||'-'}
Période: ${period}
Formule: ${c.mode} — ${c.formulaLabel}
Heures/jour: ${c.hoursPerDay}
Total loyer HT: ${fmt.format(c.totalHt)}
TVA 20%: ${fmt.format(c.tva)}
Total TTC (loyer): ${fmt.format(c.ttc)}
Acompte 50%: ${fmt.format(c.deposit)}
Redevance 2% (HT, séparée): ${(c.mode==='Longue durée' && c.feeEst>0)?fmt.format(c.feeEst):'—'}
Matériel: ${c.gearList.join(', ') || '-'}
CGV/Contrat: accepté si coché.`);
  id('emailLink').href=`mailto:${EMAIL}?subject=${subject}&body=${body}`;

  // CGV récap
  id('cv-name').textContent   = fName.value||'—';
  id('cv-phone').textContent  = fPhone.value||'—';
  id('cv-email').textContent  = fEmail.value||'—';
  id('cv-period').textContent = period;
  id('cv-hpd').textContent    = c.hoursPerDay||'—';
  id('cv-formula').textContent= c.formulaLabel||'—';
  id('cv-mode').textContent   = c.mode||'—';
  id('cv-gear-list').textContent = c.gearList.length? c.gearList.join(', ') : '—';
  id('cv-ht').textContent     = fmt.format(c.totalHt);
  id('cv-tva').textContent    = fmt.format(c.tva);
  id('cv-ttc').textContent    = fmt.format(c.ttc);
  id('cv-deposit').textContent= fmt.format(c.deposit);
  id('cv-fee').textContent    = (c.mode==='Longue durée' && c.feeEst>0)? fmt.format(c.feeEst) : '—';
}

/* Listeners (inclut les champs date) */
['input','change'].forEach(evt=>{
  [fStartDate,fEndDate,fName,fPhone,fEmail,fNote,startTime,hpd,fs,fl,fCA]
    .forEach(el=>el.addEventListener(evt,updateAll));
  GEAR.forEach(g=>id(g.id).addEventListener('change',updateAll));
});

/* Reset */
id('resetBtn').onclick=()=>setTimeout(()=>{
  const t=todayYMD(); fStartDate.value=t; fEndDate.value=t;
  fName.value=''; fPhone.value=''; fEmail.value=''; fNote.value='';
  startTime.value='10:00'; hpd.value='4';
  fs.value=''; fl.value=''; fs.disabled=false; fl.disabled=false; hpd.disabled=false;
  GEAR.forEach(g=>{ id(g.id).value='0'; });
  id('q-clipper').value='1'; id('q-trimmer').value='1'; id('q-shaver').value='1'; id('q-dryer').value='1'; id('q-cape').value='1'; id('q-towel').value='1';
  id('q-pack-ess').value='0'; id('q-pack-prem').value='0';
  caBlock.style.display='none'; if(fCA) fCA.value='';
  updateAll();
},0);

/* Init defaults */
(function init(){
  const t=todayYMD(); fStartDate.value=t; fEndDate.value=t;
  startTime.value='10:00'; hpd.value='4';
  id('q-clipper').value='1'; id('q-trimmer').value='1'; id('q-shaver').value='1'; id('q-dryer').value='1';
  id('q-cape').value='1'; id('q-towel').value='1';
  id('q-pack-ess').value='0'; id('q-pack-prem').value='0';
  updateAll();
})();

/* Submit => WhatsApp */
id('rentForm').addEventListener('submit',(e)=>{
  e.preventDefault();
  if(!(fName.value.trim() && fPhone.value.trim())){ alert('Merci de renseigner nom/prénom et téléphone.'); return; }
  if(!id('f-cgv').checked){ alert('Merci d’accepter les CGV (clique pour voir le contrat).'); return; }
  if(!fs.value && !fl.value){ alert('Choisis une formule (courte OU longue durée).'); return; }

  const c=compute();
  const msg =
`Demande de location — PHENO&CO
• Nom: ${fName.value.trim()}
• Tel: ${fPhone.value.trim()} • Email: ${fEmail.value||'-'}
• Période: ${ymdText(c.sd,c.ed,id('f-start-time').value)}${c.autoEndText||''}
• Formule: ${c.mode} — ${c.formulaLabel}
• Heures/jour: ${c.hoursPerDay}
• Total loyer HT: ${fmt.format(c.totalHt)} • TVA: ${fmt.format(c.tva)}
• Total TTC (loyer): ${fmt.format(c.ttc)} • Acompte 50%: ${fmt.format(c.deposit)}
• Matériel: ${c.gearList.join(', ') || '-'}
• Redevance 2% (HT, séparée): ${(c.mode==='Longue durée' && c.feeEst>0)?fmt.format(c.feeEst):'—'}

CGV: accepté ✅ — merci d’envoyer le lien de paiement (50%).`;
  window.open(`https://wa.me/${PHONE}?text=${encodeURIComponent(msg)}`,'_blank','noopener');
});
</script>
